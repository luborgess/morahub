# üóÑÔ∏è Arquitetura do Banco de Dados

> MoraHub - Documenta√ß√£o t√©cnica do esquema de dados e fluxos principais

## üìä Diagrama ER

```mermaid
erDiagram
    %% Relacionamentos principais
    HOUSING ||--o{ USERS : "mora em"
    USERS ||--o{ VALIDATIONS : "possui"
    USERS ||--o{ LISTINGS : "cria"
    CATEGORIES ||--o{ SUBCATEGORIES : "tem"
    CATEGORIES ||--o{ LISTINGS : "pertence"
    SUBCATEGORIES ||--o{ LISTINGS : "pertence"

    %% Entidades e seus atributos
    HOUSING {
        UUID id PK "Identificador √∫nico"
        TEXT name "Nome da moradia"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }

    USERS {
        UUID id PK "Identificador √∫nico"
        UUID housing_id FK "Refer√™ncia √† moradia"
        TEXT email "Email do usu√°rio"
        TEXT name "Nome completo"
        TEXT commercial_name "Nome comercial/apelido"
        TEXT celular "N√∫mero de celular"
        TEXT cpf "CPF do usu√°rio"
        TEXT bio "Biografia/descri√ß√£o"
        TEXT image_url "URL da foto de perfil"
        ENUM type "Tipo de usu√°rio"
        ENUM status "Status da conta"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }

    VALIDATIONS {
        UUID id PK "Identificador √∫nico"
        UUID user_id FK "Refer√™ncia ao usu√°rio"
        ENUM type "Tipo de valida√ß√£o"
        ENUM status "Status da valida√ß√£o"
        TEXT document_url "URL do documento"
        TEXT observacao "Observa√ß√µes"
        TEXT response "Resposta da valida√ß√£o"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }

    CATEGORIES {
        UUID id PK "Identificador √∫nico"
        TEXT name "Nome da categoria"
        TEXT description "Descri√ß√£o"
        TEXT icon "√çcone da categoria"
        ENUM type "Tipo da categoria"
        BOOLEAN active "Status ativo/inativo"
        INTEGER order "Ordem de exibi√ß√£o"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }

    SUBCATEGORIES {
        UUID id PK "Identificador √∫nico"
        UUID category_id FK "Refer√™ncia √† categoria"
        TEXT name "Nome da subcategoria"
        TEXT description "Descri√ß√£o"
        BOOLEAN active "Status ativo/inativo"
        INTEGER order "Ordem de exibi√ß√£o"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }

    LISTINGS {
        UUID id PK "Identificador √∫nico"
        UUID user_id FK "Refer√™ncia ao usu√°rio"
        UUID category_id FK "Refer√™ncia √† categoria"
        UUID subcategory_id FK "Refer√™ncia √† subcategoria"
        TEXT title "T√≠tulo do an√∫ncio"
        TEXT description "Descri√ß√£o detalhada"
        DECIMAL price "Pre√ßo do item"
        ENUM type "Tipo do an√∫ncio"
        ENUM status "Status do an√∫ncio"
        TEXT[] images "URLs das imagens"
        TEXT condition "Condi√ß√£o do item"
        TEXT availability "Disponibilidade"
        INTEGER visualizacoes "Contador de visualiza√ß√µes"
        TIMESTAMP created_at "Data de cria√ß√£o"
        TIMESTAMP updated_at "Data de atualiza√ß√£o"
    }
```

## üîÑ Tipos ENUM

### User Type
| Valor | Descri√ß√£o | Permiss√µes |
|-------|-----------|------------|
| `VISITOR` | Visitante sem v√≠nculo | Visualiza√ß√£o b√°sica |
| `UFMG` | Membro da comunidade UFMG | Acesso a todas funcionalidades |
| `RESIDENT` | Morador de moradia | Acesso privilegiado |
| `ADMIN` | Administrador do sistema | Acesso total |

### User Status
| Valor | Descri√ß√£o | Comportamento |
|-------|-----------|---------------|
| `ACTIVE` | Usu√°rio ativo | Acesso total |
| `INACTIVE` | Usu√°rio inativo | Sem acesso |
| `BLOCKED` | Usu√°rio bloqueado | Banido do sistema |

### Validation Type
| Valor | Descri√ß√£o | Documentos Necess√°rios |
|-------|-----------|----------------------|
| `HOUSING` | Valida√ß√£o de moradia | Comprovante de resid√™ncia |
| `UFMG_AFFILIATION` | Valida√ß√£o UFMG | Comprovante de v√≠nculo |

### Validation Status
| Valor | Descri√ß√£o | Pr√≥ximos Passos |
|-------|-----------|-----------------|
| `PENDING` | Em an√°lise | Aguardar revis√£o |
| `APPROVED` | Aprovado | Acesso liberado |
| `REJECTED` | Rejeitado | Submeter novamente |

### Listing Type
| Valor | Descri√ß√£o | Caracter√≠sticas |
|-------|-----------|-----------------|
| `PRODUCT` | Produto f√≠sico | Requer imagens |
| `SERVICE` | Servi√ßo | Requer descri√ß√£o detalhada |

### Listing Status
| Valor | Descri√ß√£o | Visibilidade |
|-------|-----------|--------------|
| `ACTIVE` | An√∫ncio ativo | Vis√≠vel para todos |
| `INACTIVE` | An√∫ncio pausado | Vis√≠vel s√≥ para dono |
| `SOLD` | Item vendido | Marcado como vendido |
| `DELETED` | An√∫ncio removido | N√£o vis√≠vel |

## üìù Notas T√©cnicas

### Conven√ß√µes
- Todos os `id` s√£o UUIDs v4
- Timestamps s√£o armazenados em UTC
- Arrays s√£o implementados como JSONB no PostgreSQL
- Campos de texto longos s√£o limitados a 2000 caracteres
- Pre√ßos s√£o armazenados com 2 casas decimais

### √çndices
- Chaves prim√°rias (PK): √≠ndice B-tree
- Chaves estrangeiras (FK): √≠ndice B-tree
- Campos de busca: √≠ndice GiST para texto
- Status e tipos: √≠ndice Hash

### Constraints
- Chaves estrangeiras com DELETE CASCADE
- Campos obrigat√≥rios: id, created_at
- Valida√ß√µes de email e CPF
- Limite de 10 imagens por an√∫ncio

### Seguran√ßa
- Row Level Security (RLS) ativo
- Pol√≠ticas por tipo de usu√°rio
- Auditoria de mudan√ßas
- Backup di√°rio

## üîÑ Fluxos Principais

### Cria√ß√£o de An√∫ncio
1. Usu√°rio autenticado cria listing
2. Valida√ß√£o de campos obrigat√≥rios
3. Processamento de imagens
4. Notifica√ß√£o para modera√ß√£o

### Valida√ß√£o de Usu√°rio
1. Upload de documentos
2. Cria√ß√£o do registro de valida√ß√£o
3. An√°lise por administrador
4. Atualiza√ß√£o de status

## üìö Refer√™ncias

- [Documenta√ß√£o PostgreSQL](https://www.postgresql.org/docs/)
- [Supabase Schema](https://supabase.com/docs/guides/database)
- [Mermaid ER Diagrams](https://mermaid.js.org/syntax/entityRelationshipDiagram.html)
